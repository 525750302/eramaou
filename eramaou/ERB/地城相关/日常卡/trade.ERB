;-------------------------------------------------
;关于モンスター交易相关的内容部分
;在商店界面可以
;-------------------------------------------------
@TRADE_SUCCUBUS
#DIM COUNT1
#DIM COUNT2
#DIM CHOICE
#DIM MEMO_LINECOUNT

$RESTART_MARK
MEMO_LINECOUNT = LINECOUNT
PRINTL
PRINTFORML 怪物と人間の仲介者である旅行商人が訪れました。
PRINTFORML 旅行者たちは、面白い物語だけでなく、多くの取引ができる商品も持ち帰ってきました。
CALL PRINT_STRL, @"十分な_黄色_金貨_と_爱心粉红_水晶_があれば、旅行商人たちは喜んで魔王城の建設に協力します。"
PRINTL
LOCALS:0 = {MONEY}金貨
LOCALS:1 = {FLAG:水晶}水晶
CALL PRINT_STRL, @"いまは_黄色_%TEXT_LJ(LOCALS:0,20)%_爱心粉红_%TEXT_LJ(LOCALS:1,20)%_を持っている"

CALL DRAWLINES_CENTER_DIY, "◈旅行商人◈", "-"


ALIGNMENT CENTER

FOR COUNT1, 0, 5
    CALL PRINT_CARD_TOP , 18
NEXT
PRINTL

LOCALS =  [400]召唤
IF MONEY < 10 + 10*FLAG:魔界召唤次数 && FLAG:水晶 < 3
    CALL PRINT_CARD_BUTTON , 18, LOCALS, 0
ELSE
    CALL PRINT_CARD_TEXT , 18, LOCALS
ENDIF

LOCALS =  [401]设施修建
IF MONEY < 10 + 10*FLAG:设施修建次数 && FLAG:水晶 < 3
    CALL PRINT_CARD_BUTTON , 18, LOCALS, 0
ELSE
    CALL PRINT_CARD_TEXT , 18, LOCALS
ENDIF

LOCALS =  [402]武器製造
IF MONEY < 10 + 10*FLAG:魔武打造次数 && FLAG:水晶 < 3
    CALL PRINT_CARD_BUTTON , 18, LOCALS, 0
ELSE
    CALL PRINT_CARD_TEXT , 18, LOCALS
ENDIF

;设施获得的经验值等同于（10*金币数 + （500 + 10*天数）*水晶）
;具体花费的金额由玩家决定
LOCALS =  [403]施設改善
CALL PRINT_CARD_BUTTON , 18, LOCALS, 0

LOCALS =  [404]資金援助
IF FLAG:水晶 < 5*FLAG:资助次数 + 5
    CALL PRINT_CARD_BUTTON , 18, LOCALS, 0
ELSE
    CALL PRINT_CARD_TEXT , 18, LOCALS
ENDIF

PRINTL

FOR COUNT1,0,3
    LOCALS = 金{10 + FLAG:(60 + COUNT1)*10}/精3
    IF FLAG:水晶 < 3 && MONEY < 10 + FLAG:(60 + COUNT1)*10
        SETCOLOR DEF_COLOR("灰色")
        CALL PRINT_CARD_TEXT , 18, LOCALS
    ELSE
        CALL PRINT_CARD_TEXT , 18, LOCALS
    ENDIF

NEXT
LOCALS = 
CALL PRINT_CARD_TEXT , 18, LOCALS

LOCALS = 精{5*FLAG:资助次数 + 5}
IF FLAG:水晶 < 5*FLAG:资助次数 + 5
    SETCOLOR DEF_COLOR("灰色")
    CALL PRINT_CARD_TEXT , 18, LOCALS
ELSE
    CALL PRINT_CARD_TEXT , 18, LOCALS
ENDIF

PRINTL

FOR COUNT1, 0, 5
    CALL PRINT_CARD_DOWN , 18
NEXT
PRINTL
ALIGNMENT LEFT
PRINTFORML [999]戻る

PRINTL

$INPUT_LOOP

CALL INPUT_SELECT, 1,400,401,402,403,404,999
CHOICE = RESULT

SELECTCASE CHOICE
CASE 400 TO 403
    CALL PRINT_STRL, @"支払い方法は？"
    IF MONEY < 10 + FLAG:(60 + CHOICE - 400)*10
        LOCALS = [100]金币￥{10 + FLAG:(60 + CHOICE - 400)*10}
        CALL PRINT_UNUSABLE_BUTTON,LOCALS
    ELSE
        PRINTFORML [100]金币￥{10 + FLAG:(60 + CHOICE - 400)*10}
    ENDIF

    IF FLAG:水晶 < 3
        LOCALS = [101]水晶◈3
        CALL PRINT_UNUSABLE_BUTTON, LOCALS
    ELSE
        PRINTFORML [101]水晶◈3
    ENDIF

    PRINTFORML [200]戻る
    
    CALL INPUT_SELECT, 1,100,101,200
    SELECTCASE RESULT
    CASE 100
        MONEY -= 10 + FLAG:(60 + CHOICE - 400)*10
        FLAG:(60 + CHOICE - 400) += 1
        CALL TRADER_WORK, CHOICE
    CASE 101
        FLAG:水晶 -= 3
        FLAG:(60 + CHOICE - 400) += 1
        CALL TRADER_WORK, CHOICE
    CASE 200

    ENDSELECT


CASE 403
    CALL TRADER_WORK, CHOICE
CASE 404
    CALL PRINT_STRL, @"本当に商人を支援するつもりですか？"

    PRINTFORML [100]はい
    PRINTFORML [200]戻る
    CALL INPUT_SELECT, 1,100,101,200
    SELECTCASE RESULT
    CASE 100
        CALL PRINT_STRL, @"「ありがとうございます。」"
        CALL PRINT_STRL, @"「これからもっといい商品を提供するぞ」"
        FLAG:水晶 -= 5*FLAG:资助次数 + 5
        FLAG:资助次数 += 1
        CALL TRADER_WORK, CHOICE
    CASE 200
        

    ENDSELECT
CASE 999
    RETURN 

ENDSELECT

CLEARLINE LINECOUNT - MEMO_LINECOUNT
GOTO RESTART_MARK

;商店执行购买得到的效果
@TRADER_WORK, ARG

SELECTCASE ARG
CASE 400
    CALL GET_SUCCUBUS_TRADE_RESULT
CASE 401
    CALL GET_ROOM_TRADE_RESULT
CASE 402
    CALL GET_WEAPON_TRADE_RESULT
CASE 403
    PRINTFORML 改善したい施設を選択してください
ENDSELECT




;--------------------------------------------
@GET_SUCCUBUS_TRADE_RESULT
#DIM COUNT1
#DIM COUNT2
#DIM SUCCUBUSNO,3
#DIM ROOMNO,3
#DIM SUCCUBUS_RANK
#DIM ROOM_RANK
#DIM ROOM_LEVEL,3
#DIM EXP_COUNT
#DIM GAIN_LEVEL
#DIM GAIN_JB
#DIM MEMO_LINECOUNT
#DIM CHARA_NO,3

;-----------------TEST
CALL DECIDE_SUCCUBUS_LOOT
SUCCUBUS_RANK = 1

;决定抽到的モンスター编号和设施编号
CALL RAND_SUCCUBUS_IN_RANK, SUCCUBUS_RANK
SUCCUBUSNO:0 = RESULT
CALL RAND_SUCCUBUS_IN_RANK, SUCCUBUS_RANK
SUCCUBUSNO:1 = RESULT
CALL RAND_SUCCUBUS_IN_RANK, SUCCUBUS_RANK
SUCCUBUSNO:2 = RESULT

;奖励的レベル
;每天获得100点经验值
;实际生成临时モンスター
EXP_COUNT = 100 * DAY
FOR COUNT1, 0, 3
    GAIN_LEVEL = EXP_TO_LEVEL(1, EXP_COUNT, 0) + RAND(20)
    CALL ADD_SUCCUBUS_CHARA, SUCCUBUSNO:COUNT1, GAIN_LEVEL
    CHARA_NO:COUNT1 = RESULT
NEXT
ALIGNMENT CENTER

;一张奖励卡
;奖励卡宽度为20 一行4张卡片
;高度为8
;第一行为卡片种类 第二行为卡片按钮的数字显示
;第三行为卡片名字全称
;第四行为怪物卡的星级 或者设施卡的星级
;第五行为怪物卡的レベル 或者设施卡的レベル
;第六行为是否选中这个卡
;点击卡片会显示卡片的相关说明信息
;决定后进行相关操作

MEMO_LINECOUNT = LINECOUNT
$PRINT_CARD

FOR COUNT1, 0, 3
    CALL PRINT_CARD_TOP , 20
NEXT
PRINTL

FOR COUNT1, 0, 3
    TRYCALLFORM SUCCUBUS_NAME_{SUCCUBUSNO:COUNT1}
    CALL PRINT_CARD_BUTTON, 20, TEXT_RETURN:0, 300 + COUNT1
NEXT
PRINTL
FOR COUNT1, 0, 3
    TRYCALLFORM SUCCUBUS_STAR_{SUCCUBUSNO:COUNT1}
    LOCALS = 
    FOR COUNT2, 0, RESULT
        LOCALS = %LOCALS%★
    NEXT
    CALL PRINT_CARD_TEXT, 20, LOCALS
NEXT
PRINTL

;经验值レベル
FOR COUNT1, 0, 3
    LOCALS = LV.{BASE:(CHARA_NO:COUNT1):レベル}
    CALL PRINT_CARD_TEXT, 20, LOCALS
NEXT
PRINTL

FOR COUNT1, 0, 3
    LOCALS =  [{400+COUNT1}] ▲これ
    CALL PRINT_CARD_TEXT , 20, LOCALS
NEXT
PRINTL

FOR COUNT1, 0, 3
    CALL PRINT_CARD_DOWN , 20
NEXT
PRINTL

;卡片打印完成

PRINTL
ALIGNMENT LEFT

$INPUT_LOOP
INPUT
LOCAL = RESULT
SELECTCASE LOCAL 
    CASE 300
        CALL PRINT_CHARA, CHARA_NO:0
    CASE 301
        CALL PRINT_CHARA, CHARA_NO:1
    CASE 302
        CALL PRINT_CHARA, CHARA_NO:2
    CASE 400
        CALL DEL_SUCCUBUS_CHARA ,  CHARA_NO:2
        CALL DEL_SUCCUBUS_CHARA ,  CHARA_NO:1
        RETURN
    CASE 401
        CALL DEL_SUCCUBUS_CHARA ,  CHARA_NO:2
        CALL DEL_SUCCUBUS_CHARA ,  CHARA_NO:0
        RETURN
    CASE 402
        CALL DEL_SUCCUBUS_CHARA ,  CHARA_NO:1
        CALL DEL_SUCCUBUS_CHARA ,  CHARA_NO:0
        RETURN
    CASEELSE   
        GOTO INPUT_LOOP
ENDSELECT


CLEARLINE LINECOUNT - MEMO_LINECOUNT
GOTO PRINT_CARD

;--------------------------------------------
@GET_ROOM_TRADE_RESULT
#DIM COUNT1
#DIM COUNT2
#DIM ROOMNO,3
#DIM ROOM_RANK
#DIM ROOM_LEVEL,3
#DIM EXP_COUNT
#DIM GAIN_LEVEL
#DIM GAIN_JB
#DIM MEMO_LINECOUNT

;-----------------TEST
CALL DECIDE_ROOM_LOOT
ROOM_RANK = 1

;决定抽到的モンスター编号和设施编号
CALL RAND_ROOM_IN_RANK, ROOM_RANK
ROOMNO:0 = RESULT
CALL RAND_ROOM_IN_RANK, ROOM_RANK
ROOMNO:1 = RESULT
CALL RAND_ROOM_IN_RANK, ROOM_RANK
ROOMNO:2 = RESULT

;一张奖励卡
;奖励卡宽度为20 一行4张卡片
;高度为8
;第一行为卡片种类 第二行为卡片按钮的数字显示
;第三行为卡片名字全称
;第四行为怪物卡的星级 或者设施卡的星级
;第五行为怪物卡的レベル 或者设施卡的レベル
;第六行为是否选中这个卡
;点击卡片会显示卡片的相关说明信息
;决定后进行相关操作

MEMO_LINECOUNT = LINECOUNT
$PRINT_CARD

FOR COUNT1, 0, 3
    CALL PRINT_CARD_TOP , 20
NEXT
PRINTL

CALL ROOM_STYLE, ROOMNO:0
CALL PRINT_CARD_TEXT, 20, TEXT_RETURN:0
CALL ROOM_STYLE, ROOMNO:1
CALL PRINT_CARD_TEXT, 20, TEXT_RETURN:0
CALL ROOM_STYLE, ROOMNO:2
CALL PRINT_CARD_TEXT, 20, TEXT_RETURN:0
PRINTL

FOR COUNT1, 0 ,3
    TRYCALLFORM ROOM_NAME_{ROOMNO:COUNT1}
    CALL PRINT_CARD_BUTTON, 20, TEXT_RETURN:0, 300 + COUNT1
NEXT
PRINTL

FOR COUNT1, 0, 3
    TRYCALLFORM ROOM_RANK_{ROOMNO:COUNT1}
    LOCAL = RESULT
    LOCALS = 
    FOR COUNT2, 0, LOCAL
        LOCALS = %LOCALS%★
    NEXT
    CALL PRINT_CARD_TEXT, 20, LOCALS
NEXT
PRINTL

;经验值レベル
FOR COUNT1, 0, 3
    ROOM_LEVEL:COUNT1 = RAND(MAX(1,DAY/10 - (ROOM_RANK - 1)*10)) + 1
    LOCALS = LV.{ROOM_LEVEL:COUNT1}
    CALL PRINT_CARD_TEXT, 20, LOCALS
NEXT
PRINTL

FOR COUNT1, 0, 3
    LOCALS =  [{400+COUNT1}] ▲これ
    CALL PRINT_CARD_TEXT , 20, LOCALS
NEXT
PRINTL

FOR COUNT1, 0, 3
    CALL PRINT_CARD_DOWN , 20
NEXT
PRINTL

;卡片打印完成

PRINTL
ALIGNMENT LEFT

$INPUT_LOOP
INPUT
LOCAL = RESULT
SELECTCASE LOCAL 
    CASE 300
        CALL PRINT_ROOM, ROOMNO:0, ROOM_LEVEL:0,-1,-1
    CASE 301
        CALL PRINT_ROOM, ROOMNO:1, ROOM_LEVEL:1,-1,-1
    CASE 301
        CALL PRINT_ROOM, ROOMNO:2, ROOM_LEVEL:2,-1,-1
    CASE 400
        CALL ROOM_SET, ROOMNO:0, ROOM_LEVEL:0
        RETURN
    CASE 401
        CALL ROOM_SET, ROOMNO:1, ROOM_LEVEL:1
        RETURN
    CASE 402
        CALL ROOM_SET, ROOMNO:2, ROOM_LEVEL:2
        RETURN
    CASEELSE   
        GOTO INPUT_LOOP
ENDSELECT


CLEARLINE LINECOUNT - MEMO_LINECOUNT
GOTO PRINT_CARD

@GET_WEAPON_TRADE_RESULT

#DIM COUNT1
#DIM COUNT2
#DIM WEAPONNO,3
#DIM WEAPON_RANK
#DIM MEMO_LINECOUNT

CALL DECIDE_WEAPON_LOOT
;-------------------TEST
WEAPON_RANK = 1

;决定抽到的武器编号
CALL RAND_WEAPON_IN_RANK, WEAPON_RANK
WEAPONNO:0 = RESULT
CALL RAND_WEAPON_IN_RANK, WEAPON_RANK
WEAPONNO:1 = RESULT
CALL RAND_WEAPON_IN_RANK, WEAPON_RANK
WEAPONNO:2 = RESULT

;一张奖励卡
;奖励卡宽度为20 一行4张卡片
;高度为8
;第一行为卡片种类 第二行为卡片按钮的数字显示
;第三行为卡片名字全称
;第四行为武器的星级
;第五行为是否选中这个卡
;点击卡片会显示卡片的相关说明信息
;决定后进行相关操作

MEMO_LINECOUNT = LINECOUNT
$PRINT_CARD

FOR COUNT1, 0, 3
    CALL PRINT_CARD_TOP , 20
NEXT
PRINTL

TRYCALLFORM WEAPON_STYLE_{(WEAPONNO:0)}
CALL WEAPON_STYLE, RESULT
CALL PRINT_CARD_TEXT, 20, TEXT_RETURN:0
TRYCALLFORM WEAPON_STYLE_{(WEAPONNO:1)}
CALL WEAPON_STYLE, RESULT
CALL PRINT_CARD_TEXT, 20, TEXT_RETURN:0
TRYCALLFORM WEAPON_STYLE_{(WEAPONNO:2)}
CALL WEAPON_STYLE, RESULT
CALL PRINT_CARD_TEXT, 20, TEXT_RETURN:0
PRINTL

FOR COUNT1, 0 ,3
    TRYCALLFORM WEAPON_NAME_{WEAPONNO:COUNT1}
    CALL PRINT_CARD_BUTTON, 20, TEXT_RETURN:0, 300 + COUNT1
NEXT
PRINTL

FOR COUNT1, 0, 3
    TRYCALLFORM WEAPON_RANK_{WEAPONNO:COUNT1}
    LOCAL = RESULT
    LOCALS = 
    FOR COUNT2, 0, LOCAL
        LOCALS = %LOCALS%★
    NEXT
    CALL PRINT_CARD_TEXT, 20, LOCALS
NEXT
PRINTL

FOR COUNT1, 0, 3
    LOCALS =  [{400+COUNT1}] ▲要这个
    CALL PRINT_CARD_TEXT , 20, LOCALS
NEXT
PRINTL

FOR COUNT1, 0, 3
    CALL PRINT_CARD_DOWN , 20
NEXT
PRINTL

;卡片打印完成

PRINTL
ALIGNMENT LEFT

$INPUT_LOOP
INPUT
LOCAL = RESULT
SELECTCASE LOCAL 
    CASE 300
        CALL PRINT_WEAPON, WEAPONNO:0
    CASE 301
        CALL PRINT_WEAPON, WEAPONNO:1
    CASE 301
        CALL PRINT_WEAPON, WEAPONNO:2
    CASE 400
        ITEM:(WEAPONNO:0) += 1
        RETURN
    CASE 401
        ITEM:(WEAPONNO:1) += 1
        RETURN
    CASE 401
        ITEM:(WEAPONNO:2) += 1
        RETURN
    CASEELSE   
        GOTO INPUT_LOOP
ENDSELECT


CLEARLINE LINECOUNT - MEMO_LINECOUNT
GOTO PRINT_CARD